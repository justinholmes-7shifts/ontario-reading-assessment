{% extends "base.html" %}

{% block title %}{{ prompt.title }} - Writing Assessment{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ prompt.title }}</h2>
    <p class="type">{{ prompt.type }} | Grade {{ prompt.grade }}</p>
    <p><strong>Word Count:</strong> {{ prompt.word_minimum }}-{{ prompt.word_maximum }} words</p>
</div>

<div class="card">
    <h3>Writing Prompt</h3>
    <div class="writing-prompt">{{ prompt.prompt }}</div>
</div>

<!-- Think First Planning Framework -->
<div class="card" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid #1a5f7a;">
    <h3 style="color: #1a5f7a;">Think First: Plan Before You Write</h3>
    <p style="margin-bottom: 16px; color: #666;">Great writers plan their thinking before they start writing. Work through these steps:</p>

    <div class="think-first-steps">
        <div class="think-step">
            <div class="step-number">1</div>
            <div class="step-content">
                <h4>Understand the Situation</h4>
                <p>What's happening? What background does your reader need to know?</p>
            </div>
        </div>

        <div class="think-step">
            <div class="step-number">2</div>
            <div class="step-content">
                <h4>Identify the Challenge</h4>
                <p>What's the problem, tension, or interesting question here?</p>
            </div>
        </div>

        <div class="think-step">
            <div class="step-number">3</div>
            <div class="step-content">
                <h4>Focus Your Message</h4>
                <p><strong>If you could only tell your reader ONE thing, what would it be?</strong> Write this first!</p>
            </div>
        </div>

        <div class="think-step">
            <div class="step-number">4</div>
            <div class="step-content">
                <h4>Build Your Support</h4>
                <p>What are 2-4 <em>different</em> reasons or points that support your main message? (Make sure they don't overlap!)</p>
            </div>
        </div>

        <div class="think-step">
            <div class="step-number">5</div>
            <div class="step-content">
                <h4>Check Your Logic</h4>
                <p>Does each supporting point answer 'why?' or 'how?' about your main message?</p>
            </div>
        </div>
    </div>
</div>

<div class="planning-questions">
    <h4>Planning Questions for This Prompt</h4>
    <p>Before you write, think about:</p>
    <ul>
        {% for question in prompt.planning_questions %}
        <li>{{ question }}</li>
        {% endfor %}
    </ul>
</div>

{% if prompt.structure_tips %}
<div class="card" style="background-color: #fff9f0; border-left: 4px solid #c38154;">
    <h4 style="color: #c38154;">Structure Tips</h4>
    <ul style="margin-left: 20px; margin-top: 12px;">
        {% for tip in prompt.structure_tips %}
        <li>{{ tip }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="success-criteria">
    <h4>Success Criteria</h4>
    <p>Your writing should:</p>
    <ul>
        {% for criterion in prompt.success_criteria %}
        <li>{{ criterion }}</li>
        {% endfor %}
    </ul>
</div>

<form id="writing-form">
    <input type="hidden" name="prompt_id" value="{{ prompt.id }}">

    <div class="card">
        <h3>Your Response</h3>
        <p style="color: #666; margin-bottom: 12px;"><strong>Remember:</strong> Start with your main point. Then support it with distinct reasons that each answer 'why?' or 'how?'</p>
        <textarea
            class="writing-area"
            name="response"
            id="response"
            placeholder="Start with your main message..."
            required
        ></textarea>
        <div class="word-count" id="word-count">
            Words: 0 | Target: {{ prompt.word_minimum }}-{{ prompt.word_maximum }}
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Submit Writing</button>
</form>

<div id="results-container" style="display: none;"></div>

<style>
.think-first-steps {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.think-step {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.step-number {
    width: 32px;
    height: 32px;
    background: #1a5f7a;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}

.step-content h4 {
    margin: 0 0 4px 0;
    color: #1a5f7a;
    font-size: 1rem;
}

.step-content p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
const wordMin = {{ prompt.word_minimum }};
const wordMax = {{ prompt.word_maximum }};
const textarea = document.getElementById('response');
const wordCountDisplay = document.getElementById('word-count');

textarea.addEventListener('input', function() {
    const text = this.value.trim();
    const words = text ? text.split(/\s+/).length : 0;

    wordCountDisplay.textContent = `Words: ${words} | Target: ${wordMin}-${wordMax}`;

    wordCountDisplay.classList.remove('warning', 'error', 'success');
    if (words < wordMin) {
        wordCountDisplay.classList.add('warning');
    } else if (words > wordMax) {
        wordCountDisplay.classList.add('error');
    } else {
        wordCountDisplay.classList.add('success');
    }
});

document.getElementById('writing-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const response = formData.get('response');

    try {
        const res = await fetch('/writing/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                prompt_id: formData.get('prompt_id'),
                response: response
            })
        });

        const results = await res.json();
        displayResults(results, response);
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while submitting your writing.');
    }
});

function displayResults(results, studentResponse) {
    document.getElementById('writing-form').style.display = 'none';
    document.querySelector('.think-first-steps')?.closest('.card')?.remove();
    document.querySelector('.planning-questions')?.remove();
    document.querySelector('.success-criteria')?.remove();

    const container = document.getElementById('results-container');
    container.style.display = 'block';

    let html = `
        <div class="card">
            <h2>Writing Assessment Results</h2>
            <h3>${results.prompt_title}</h3>
            <p class="type">${results.prompt_type}</p>
        </div>
    `;

    // Text metrics
    html += `
        <div class="card">
            <h3>Text Analysis</h3>
            <div class="skill-breakdown">
                <div class="skill-item">
                    <h4>Word Count</h4>
                    <div class="percentage">${results.text_metrics.word_count}</div>
                    <p>Target: ${results.text_metrics.word_minimum}-${results.text_metrics.word_maximum}</p>
                </div>
                <div class="skill-item">
                    <h4>Sentences</h4>
                    <div class="percentage">${results.text_metrics.sentence_count}</div>
                </div>
                <div class="skill-item">
                    <h4>Paragraphs</h4>
                    <div class="percentage">${results.text_metrics.paragraph_count}</div>
                </div>
                <div class="skill-item">
                    <h4>Avg. Sentence Length</h4>
                    <div class="percentage">${results.text_metrics.average_sentence_length}</div>
                    <p>words</p>
                </div>
            </div>
        </div>
    `;

    // Feedback
    if (results.feedback_areas.length > 0) {
        html += '<div class="card"><h3>Feedback</h3>';
        for (const fb of results.feedback_areas) {
            html += `
                <div class="feedback-item needs-improvement">
                    <strong>${fb.area}:</strong> ${fb.feedback}
                </div>
            `;
        }
        html += '</div>';
    }

    // Structure Check Questions
    if (results.structure_check_questions) {
        html += `
            <div class="card" style="background-color: #f0f7fa; border-left: 4px solid #1a5f7a;">
                <h3 style="color: #1a5f7a;">Check Your Structure</h3>
                <p>Review your writing with these questions:</p>
                <ul style="margin-left: 20px; margin-top: 12px;">
        `;
        for (const q of results.structure_check_questions) {
            html += `<li>${q}</li>`;
        }
        html += '</ul></div>';
    }

    // Rubric
    html += `
        <div class="card">
            <h3>Assessment Rubric</h3>
            <p>Use this rubric for self-assessment or teacher evaluation:</p>
            <table class="rubric-table">
                <tr>
                    <th>Category</th>
                    <th>Weight</th>
                    <th>Level 4</th>
                    <th>Level 3</th>
                    <th>Level 2</th>
                    <th>Level 1</th>
                </tr>
    `;

    for (const cat of results.rubric.categories) {
        html += `
            <tr>
                <td><strong>${cat.name}</strong><br><small>${cat.description || ''}</small></td>
                <td>${cat.weight}</td>
                <td>${cat.levels['Level 4 (80-100%)']}</td>
                <td>${cat.levels['Level 3 (70-79%)']}</td>
                <td>${cat.levels['Level 2 (60-69%)']}</td>
                <td>${cat.levels['Level 1 (50-59%)']}</td>
            </tr>
        `;
    }
    html += '</table></div>';

    // Self-assessment
    html += `
        <div class="card">
            <h3>Self-Assessment Checklist</h3>
            <p>Review your writing against these questions:</p>
            <ul style="margin-left: 20px; margin-top: 12px;">
    `;
    for (const q of results.self_assessment_questions) {
        html += `<li>${q}</li>`;
    }
    html += '</ul></div>';

    // Student's response
    html += `
        <div class="card">
            <h3>Your Writing</h3>
            <div class="passage-container">${studentResponse.replace(/\n/g, '<br>')}</div>
        </div>
    `;

    html += '<a href="/writing" class="btn btn-secondary">Try Another Prompt</a>';

    container.innerHTML = html;
    window.scrollTo(0, 0);
}
</script>
{% endblock %}
