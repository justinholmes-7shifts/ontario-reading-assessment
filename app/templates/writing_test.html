{% extends "base.html" %}

{% block title %}{{ prompt.title }} - Writing Assessment{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ prompt.title }}</h2>
    <p class="type">{{ prompt.type }} | Grade {{ prompt.grade }}</p>
    <p><strong>Word Count:</strong> {{ prompt.word_minimum }}-{{ prompt.word_maximum }} words</p>
</div>

<div class="card">
    <h3>Writing Prompt</h3>
    <div class="writing-prompt">{{ prompt.prompt }}</div>
</div>

<!-- Think First Planning Framework -->
<div class="card" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid #1a5f7a;">
    <h3 style="color: #1a5f7a;">Think First: Plan Before You Write</h3>
    <p style="margin-bottom: 16px; color: #666;">Great writers plan their thinking before they start writing. Work through these steps:</p>

    <div class="think-first-steps">
        <div class="think-step">
            <div class="step-number">1</div>
            <div class="step-content">
                <h4>Understand the Situation</h4>
                <p>What's happening? What background does your reader need to know?</p>
            </div>
        </div>

        <div class="think-step">
            <div class="step-number">2</div>
            <div class="step-content">
                <h4>Identify the Challenge</h4>
                <p>What's the problem, tension, or interesting question here?</p>
            </div>
        </div>

        <div class="think-step">
            <div class="step-number">3</div>
            <div class="step-content">
                <h4>Focus Your Message</h4>
                <p><strong>If you could only tell your reader ONE thing, what would it be?</strong> Write this first!</p>
            </div>
        </div>

        <div class="think-step">
            <div class="step-number">4</div>
            <div class="step-content">
                <h4>Build Your Support</h4>
                <p>What are 2-4 <em>different</em> reasons or points that support your main message? (Make sure they don't overlap!)</p>
            </div>
        </div>

        <div class="think-step">
            <div class="step-number">5</div>
            <div class="step-content">
                <h4>Check Your Logic</h4>
                <p>Does each supporting point answer 'why?' or 'how?' about your main message?</p>
            </div>
        </div>
    </div>
</div>

<div class="planning-questions">
    <h4>Planning Questions for This Prompt</h4>
    <p>Before you write, think about:</p>
    <ul>
        {% for question in prompt.planning_questions %}
        <li>{{ question }}</li>
        {% endfor %}
    </ul>
</div>

{% if prompt.structure_tips %}
<div class="card" style="background-color: #fff9f0; border-left: 4px solid #c38154;">
    <h4 style="color: #c38154;">Structure Tips</h4>
    <ul style="margin-left: 20px; margin-top: 12px;">
        {% for tip in prompt.structure_tips %}
        <li>{{ tip }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="success-criteria">
    <h4>Success Criteria</h4>
    <p>Your writing should:</p>
    <ul>
        {% for criterion in prompt.success_criteria %}
        <li>{{ criterion }}</li>
        {% endfor %}
    </ul>
</div>

<form id="writing-form">
    <input type="hidden" name="prompt_id" value="{{ prompt.id }}">

    <div class="card">
        <h3>Your Response</h3>
        <p style="color: #666; margin-bottom: 12px;"><strong>Remember:</strong> Start with your main point. Then support it with distinct reasons that each answer 'why?' or 'how?'</p>
        <textarea
            class="writing-area"
            name="response"
            id="response"
            placeholder="Start with your main message..."
            required
        ></textarea>
        <div class="word-count" id="word-count">
            Words: 0 | Target: {{ prompt.word_minimum }}-{{ prompt.word_maximum }}
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Submit Writing</button>
</form>

<div id="results-container" style="display: none;"></div>

<style>
.think-first-steps {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.think-step {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.step-number {
    width: 32px;
    height: 32px;
    background: #1a5f7a;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}

.step-content h4 {
    margin: 0 0 4px 0;
    color: #1a5f7a;
    font-size: 1rem;
}

.step-content p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
const wordMin = {{ prompt.word_minimum }};
const wordMax = {{ prompt.word_maximum }};
const textarea = document.getElementById('response');
const wordCountDisplay = document.getElementById('word-count');

textarea.addEventListener('input', function() {
    const text = this.value.trim();
    const words = text ? text.split(/\s+/).length : 0;

    wordCountDisplay.textContent = `Words: ${words} | Target: ${wordMin}-${wordMax}`;

    wordCountDisplay.classList.remove('warning', 'error', 'success');
    if (words < wordMin) {
        wordCountDisplay.classList.add('warning');
    } else if (words > wordMax) {
        wordCountDisplay.classList.add('error');
    } else {
        wordCountDisplay.classList.add('success');
    }
});

document.getElementById('writing-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const response = formData.get('response');

    try {
        const res = await fetch('/writing/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                prompt_id: formData.get('prompt_id'),
                response: response
            })
        });

        const results = await res.json();
        displayResults(results, response);
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while submitting your writing.');
    }
});

function displayResults(results, studentResponse) {
    document.getElementById('writing-form').style.display = 'none';
    document.querySelector('.think-first-steps')?.closest('.card')?.remove();
    document.querySelector('.planning-questions')?.remove();
    document.querySelector('.success-criteria')?.remove();
    // Also hide the structure tips card
    const structureTipsCard = document.querySelector('.card[style*="fff9f0"]');
    if (structureTipsCard) structureTipsCard.remove();

    const container = document.getElementById('results-container');
    container.style.display = 'block';

    const evaluation = results.evaluation;
    const levelColors = {
        4: '#4caf50',
        3: '#8bc34a',
        2: '#ff9800',
        1: '#f44336'
    };
    const levelLabels = {
        4: 'Excellent',
        3: 'Good',
        2: 'Developing',
        1: 'Needs Work'
    };

    let html = `
        <div class="card" style="background: linear-gradient(135deg, #1a5f7a 0%, #57837b 100%); color: white; text-align: center;">
            <h2 style="color: white; margin-bottom: 8px;">Your Results</h2>
            <div style="font-size: 3rem; font-weight: bold; margin: 16px 0;">Level ${evaluation.overall_level}</div>
            <div style="font-size: 1.5rem; opacity: 0.9;">${evaluation.overall_percentage}%</div>
            <div style="margin-top: 8px; font-size: 1.1rem;">${levelLabels[evaluation.overall_level]}</div>
        </div>
    `;

    // Overall feedback - what they did well
    html += `
        <div class="card" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
            <h3 style="color: #2e7d32; margin-top: 0;">What You Did Well</h3>
            <p style="font-size: 1.05rem; line-height: 1.6;">${evaluation.overall_feedback}</p>
        </div>
    `;

    // Top priority for improvement
    html += `
        <div class="card" style="background: #fff3e0; border-left: 4px solid #ff9800;">
            <h3 style="color: #e65100; margin-top: 0;">Your Next Step</h3>
            <p style="font-size: 1.05rem; line-height: 1.6;">${evaluation.top_priority}</p>
        </div>
    `;

    // Category breakdown
    html += `<div class="card"><h3>How You Did in Each Area</h3><div style="display: grid; gap: 16px; margin-top: 16px;">`;

    const categoryNames = {
        'main_message': 'Clear Main Message',
        'logical_structure': 'Logical Flow',
        'grouping': 'Well-Organized Ideas',
        'conventions': 'Writing Quality'
    };

    for (const [key, cat] of Object.entries(evaluation.categories)) {
        const color = levelColors[cat.level];
        html += `
            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; border-left: 4px solid ${color};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <strong>${categoryNames[key] || key}</strong>
                    <span style="background: ${color}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">
                        Level ${cat.level}
                    </span>
                </div>
                <p style="color: #2e7d32; margin: 8px 0; font-size: 0.95rem;"><strong>Strength:</strong> ${cat.strength}</p>
                <p style="color: #666; margin: 0; font-size: 0.95rem;"><strong>To improve:</strong> ${cat.improvement}</p>
            </div>
        `;
    }
    html += '</div></div>';

    // Text stats (simple)
    const wordStatus = results.text_metrics.word_count >= results.text_metrics.word_minimum &&
                       results.text_metrics.word_count <= results.text_metrics.word_maximum;
    html += `
        <div class="card">
            <h3>Writing Stats</h3>
            <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                <div>
                    <strong>Words:</strong> ${results.text_metrics.word_count}
                    <span style="color: ${wordStatus ? '#4caf50' : '#ff9800'};">
                        (target: ${results.text_metrics.word_minimum}-${results.text_metrics.word_maximum})
                    </span>
                </div>
                <div><strong>Paragraphs:</strong> ${results.text_metrics.paragraph_count}</div>
                <div><strong>Sentences:</strong> ${results.text_metrics.sentence_count}</div>
            </div>
        </div>
    `;

    // Show their writing
    html += `
        <div class="card">
            <h3>Your Writing</h3>
            <div class="passage-container" style="background: #fafafa; padding: 16px; border-radius: 8px; line-height: 1.8;">
                ${studentResponse.replace(/\n\n/g, '</p><p style="margin-top: 16px;">').replace(/\n/g, '<br>')}
            </div>
        </div>
    `;

    html += '<a href="/writing" class="btn btn-primary">Try Another Prompt</a>';

    container.innerHTML = html;
    window.scrollTo(0, 0);
}
</script>
{% endblock %}
